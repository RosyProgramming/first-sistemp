/*
 * File: app/view/gridCargo.js
 *
 * This file was generated by Sencha Architect version 4.2.4.
 * http://www.sencha.com/products/architect/
 *
 * This file requires use of the Ext JS 6.6.x Classic library, under independent license.
 * License of Sencha Architect does not include license for Ext JS 6.6.x Classic. For more
 * details see http://www.sencha.com/license or contact license@sencha.com.
 *
 * This file will be auto-generated each and everytime you save your project.
 *
 * Do NOT hand edit this file.
 */

Ext.define('rsistemp.view.gridCargo', {
    extend: 'Ext.grid.Panel',
    alias: 'widget.gridcargo',

    requires: [
        'rsistemp.view.gridCargoViewModel',
        'Ext.button.Button',
        'Ext.form.field.ComboBox',
        'Ext.view.Table',
        'Ext.grid.column.Action',
        'Ext.toolbar.Paging'
    ],

    viewModel: {
        type: 'gridcargo'
    },
    reference: 'form',
    height: 749,
    itemId: 'gridCargo',
    width: 927,
    icon: 'resources/images/grid.png',
    title: 'Cadastro de Cargo',
    columnLines: true,
    store: 'StoreCargo',
    defaultListenerScope: true,

    dockedItems: [
        {
            xtype: 'toolbar',
            dock: 'top',
            items: [
                {
                    xtype: 'button',
                    iconCls: 'x-fa fa-plus',
                    text: 'Novo',
                    listeners: {
                        click: 'onButtonClick1'
                    }
                },
                {
                    xtype: 'button',
                    dock: 'top',
                    width: 100,
                    icon: 'resources/images/excel.png',
                    text: 'Exportar',
                    listeners: {
                        click: 'onButtonClick2'
                    }
                }
            ]
        },
        {
            xtype: 'toolbar',
            dock: 'top',
            items: [
                {
                    xtype: 'combobox',
                    itemId: 'opcaoPesquisarPor',
                    fieldLabel: 'Pesquisar',
                    labelWidth: 70,
                    name: 'pesquisarpor',
                    displayField: 'descricao',
                    store: 'StoreOpcaoPesquisa',
                    valueField: 'id'
                },
                {
                    xtype: 'textfield',
                    margins: '',
                    itemId: 'pesquisarPor',
                    labelAlign: 'right',
                    labelWidth: 60
                },
                {
                    xtype: 'button',
                    iconCls: 'x-fa fa-search',
                    text: 'Pesquisar',
                    listeners: {
                        click: 'onButtonClick'
                    }
                }
            ]
        },
        {
            xtype: 'pagingtoolbar',
            dock: 'bottom',
            width: 360,
            displayInfo: true,
            store: 'StoreCargo'
        }
    ],
    columns: [
        {
            xtype: 'gridcolumn',
            dataIndex: 'cargo_id',
            text: 'Cargo_ID'
        },
        {
            xtype: 'gridcolumn',
            dataIndex: 'desc_cargo',
            text: 'Descrição'
        },
        {
            xtype: 'gridcolumn',
            renderer: function(value, metaData, record, rowIndex, colIndex, store, view) {
                if (value === 'A')
                {
                    return 'Ativo';
                } else if (value === 'I') {
                    return '<span style="color:' + 'red' + ';">INATIVO</span>';
                }else{
                    return value;
                }
            },
            dataIndex: 'status_cargo',
            text: 'Status'
        },
        {
            xtype: 'actioncolumn',
            width: 40,
            align: 'center',
            items: [
                {
                    handler: function(view, rowIndex, colIndex, item, e, record, row) {
                        // Criação do window
                        var win = Ext.create('rsistemp.view.WindowCargo', {
                            title: 'Alterar - Cargo',
                        });

                        // Referenciando o formulário
                        var form = win.queryById('cargoFormulario');

                        // getForm - > fornece acessoa ao formulario
                        form.getForm().url = '../../app/rsistemp.php?action=cargo&metodo=alterar_Cargo';

                        form.loadRecord(record);


                        win.on('close', function() {
                            // atualizar a grid
                            view.getStore().load();
                        });

                        win.show();
                    },
                    icon: 'resources/images/edit.png',
                    tooltip: 'Editar'
                }
            ]
        },
        {
            xtype: 'actioncolumn',
            width: 40,
            align: 'center',
            items: [
                {
                    handler: function(view, rowIndex, colIndex, item, e, record, row) {

                        Ext.Msg.show({
                            title:'Excluir Registro?',
                            msg: 'Tem certeza que deseja excluir o registro?',

                            buttons: Ext.Msg.YESNO,
                            icon: Ext.Msg.QUESTION,
                            fn : function(btn){
                                if ( btn == "yes"){
                                    //alert('Excluiu! - ' + record.get('nome'));

                                    //AJAX
                                    Ext.Ajax.request({
                                        //url: '../rsistemp.php?action=cartao&metodo=excluir_cargo&id=' + record.get('id'), // VIA URL
                                        url: '../../app/rsistemp.php',
                                        params: { // VIA POST
                                            action: 'cargo',
                                            metodo: 'excluir_cargo',
                                            cargo_id: record.get('cargo_id')

                                        },
                                        success: function(response){
                                            var resposta = Ext.JSON.decode(response.responseText);

                                            if(resposta.success===true)
                                            {
                                                rsistemp.getApplication().Msg(resposta.msg);
                                            }
                                            else if(resposta.success===false)
                                            {
                                                Ext.Msg.show({
                                                    title:'Atenção',
                                                    msg: resposta.msg,
                                                    buttons: Ext.Msg.OK,
                                                    icon: Ext.Msg.WARNING
                                                });
                                            }

                                            //Ext.Msg.alert('Status', resposta.msg);
                                            view.getStore().removeAll();
                                            view.getStore().load(); //LOAD NO GRID PARA ATUALIZAR O QUE É EXIBIDO!!!
                                        },
                                        failure: function(form, action) {
                                            //Ext.Msg.alert('Success', action.result.msg);
                                            Ext.Msg.show({
                                                title:'Atenção',
                                                msg: action.result.msg,
                                                buttons: Ext.Msg.OK,
                                                icon: Ext.Msg.WARNING
                                            });
                                        }
                                    });
                                }
                            }
                        });


                    },
                    icon: 'resources/images/delete.png',
                    tooltip: 'excluir'
                }
            ]
        }
    ],

    onButtonClick1: function(button, e, eOpts) {
        var win = Ext.create('rsistemp.view.WindowCargo');

        var grid = this;

        win.on('close', function() {

            grid.getStore().load();
        });
        win.show();
    },

    onButtonClick2: function(button, e, eOpts) {
        var grid = Ext.ComponentQuery.query('[itemId=gridCargo]')[0];


        // debugger;

            var cargo_id = this.queryById('cargo_id');
            var desc_cargo = this.queryById('desc_cargo');
            var status_cargo = this.queryById('status_cargo');



        //Tooltip
            var tip = Ext.create('Ext.tip.ToolTip', {
                target: Ext.getBody(),
                title: '<center><span style="color:' + 'red' + '; font-size:' + '18px' + ';font-weight:' + 'bold' + ';">Baixando arquivo excel</span></center>'

            });


        //comunicando com o php
        href = '../../app/rsistemp.php?action=cargo&metodo=export_cargo'+
                '&cargo_id='+cargo_id+
                '&desc_cargo='+desc_cargo+
                '&status_cargo='+status_cargo;

        tip.html = '<iframe src="'+href+'" name="principal" width="225px" height="10px" scrolling="auto" frameborder="0"></iframe>';

        //aparece na tela tooltip
            tip.showAt([0,0]);
            tip.alignTo(document, 't-t');
            tip.getEl().ghost('t', {
                easing: 'ease-in-out',
                duration: 5000,
                callback: function() {
                    Ext.destroy(tip);
                }
            });
    },

    onButtonClick: function(button, e, eOpts) {
        //Pegando os valores do comboBox
        var opcaoPesquisarPor = this.queryById('opcaoPesquisarPor').getValue();
        //Pegando os valores do text field
        var pesquisarPor = this.queryById('pesquisarPor').getValue();
        var Store = this.getStore();

        Store.getProxy().extraParams = {};

        Store.getProxy().extraParams.opcaoPesquisarPor = opcaoPesquisarPor;
        Store.getProxy().extraParams.pesquisarPor = pesquisarPor;
        //limpa todos os dados da store
        Store.removeAll();
        //atualiza a store
        Store.load();
    }

});